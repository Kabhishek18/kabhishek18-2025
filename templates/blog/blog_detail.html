{% extends "base.html" %}
{% load static %}
{% load blog_extras %}
{% load random_icons %}

{% block extra_css %}
    {% if toc_data.show_toc %}
        <link rel="stylesheet" href="{% static 'css/table-of-contents.css' %}">
    {% endif %}
{% endblock extra_css %}

{% block extra_js %}
    <script src="{% static 'js/blog-detail.js' %}"></script>
    <script src="{% static 'js/multimedia.js' %}"></script>
    {% if toc_data.show_toc %}
        <script src="{% static 'js/table-of-contents.js' %}"></script>
    {% endif %}
{% endblock extra_js %}

{% block meta_data %}
    {% if meta_data %}
        {{ meta_data }}
    {% else %}
        <meta name="author" content="Kumar Abhishek">
        <meta name="keywords" content="Kumar Abhishek, Full Stack Developer, Software Engineer, AI, Machine Learning, Python, React, Portfolio, Digital Architect">
        <meta name="robots" content="index, follow">
        <meta name="description" content="{{ meta_details }}">
        <link rel="canonical" href="{{ request.build_absolute_uri }}">
        
        <!-- Enhanced Social Media Meta Tags -->
        {% social_meta_tags post request %}
     {% endif %}   
{% endblock meta_data %}

{% block title %}<title>{{ title |truncatechars:10 }} - Digital Codex</title>{% endblock title %}

{% block content %}
    <div class="reading-progress"><div class="progress-bar" id="readingProgress"></div></div>

    <nav class="detail-nav">
        <div class="nav-container">
            <a href="{% url 'blog:list' %}" class="nav-back"><i class="fas fa-arrow-left"></i><span>Back to Blog</span></a>
            <div class="nav-actions">
                <button class="share-btn" id="shareBtn"><i class="fas fa-share-alt"></i><span>Share</span></button>
                <!-- <button class="bookmark-btn" id="bookmarkBtn"><i class="fas fa-bookmark"></i><span>Save</span></button> -->
            </div>
        </div>
    </nav>

    <div class="article-container">
        <header class="article-header">
            <span class="article-category">{{ post.categories.first.name|default:'General' }}</span>
            <h1 class="article-title">{{ post.title }}</h1>
            <div class="article-meta">
                <div class="meta-item"><i class="fas fa-user"></i><span>{{ post.author.get_full_name|default:post.author.username }}</span></div>
                <div class="meta-item"><i class="fas fa-calendar"></i><span>{{ post.created_at|date:"F d, Y" }}</span></div>
                <div class="meta-item"><i class="fas fa-clock"></i><span>{{ post.read_time }} min read</span></div>
                <div class="meta-item"><i class="fas fa-eye"></i><span>{{ post.view_count }} views</span></div>
            </div>
            
            {% if post.tags.all %}
                <div class="article-tags">
                    <i class="fas fa-tags"></i>
                    {% for tag in post.tags.all %}
                        <a href="{% url 'blog:list_by_tag' tag.slug %}" 
                           class="article-tag" 
                           style="--tag-color: {{ tag.color }};">
                            {{ tag.name }}
                        </a>
                    {% endfor %}
                </div>
            {% endif %}
        </header>

        {% if post.featured_image %}
            <div class="article-image"><img src="{{ post.featured_image.url }}" alt="{{ post.title }}" style="width:100%; height:auto; border-radius:15px; margin-bottom: 2rem;"></div>
        {% endif %}
        
        <!-- Table of Contents -->
        {% if toc_data.show_toc %}
            <div class="article-toc-container">
                {{ toc_data.toc_html|safe }}
            </div>
        {% endif %}
        
        <article class="article-content">
            {% if toc_data.show_toc %}
                {{ toc_data.content|safe }}
            {% else %}
                {{ post.content|safe }}
            {% endif %}
        </article>

        <!-- Social Sharing Widget -->
        {% include 'blog/includes/social_share_widget.html' %}

        <!-- <div class="article-tags">
            {% for category in post.categories.all %}
                 <a href="{% url 'blog:list_by_category' category.slug %}" class="article-tag">{{ category.name }}</a>
            {% endfor %}
        </div> -->

        <!-- Enhanced Author Bio Widget -->
        {% include 'blog/includes/author_bio_widget.html' %}
        <amp-auto-ads type="adsense"
            data-ad-client="ca-pub-6078293202282096">
        </amp-auto-ads>
        <!-- Comments Section -->
        {% if post.allow_comments %}
            <section class="comments-section" id="comments">
                <div class="comments-header">
                    <h2 class="comments-title">
                        <i class="fas fa-comments"></i>
                        Comments
                        <span class="comments-count">({{ comments.count }})</span>
                    </h2>
                    {% if comments.count > 0 %}
                        <div class="comments-sort">
                            <label for="commentSort">Sort by:</label>
                            <select id="commentSort" class="comment-sort-select">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                            </select>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Comment Form -->
                <div class="comment-form-container">
                    <div class="comment-form-header">
                        <h3>Join the Discussion</h3>
                        <p class="comment-form-subtitle">Share your thoughts and engage with the community</p>
                    </div>
                    <form method="post" action="{% url 'blog:submit_comment' post.slug %}" class="comment-form" id="commentForm">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group">
                                <label for="id_author_name">Name *</label>
                                {{ comment_form.author_name }}
                                <div class="form-error" id="name-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="id_author_email">Email *</label>
                                {{ comment_form.author_email }}
                                <div class="form-error" id="email-error"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_author_website">Website (optional)</label>
                            {{ comment_form.author_website }}
                        </div>
                        <div class="form-group">
                            <label for="id_content">Comment *</label>
                            {{ comment_form.content }}
                            <div class="character-count">
                                <span id="charCount">0</span> / 2000 characters
                            </div>
                            <div class="form-error" id="content-error"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="comment-submit-btn" id="submitBtn">
                                <i class="fas fa-paper-plane"></i>
                                <span>Post Comment</span>
                                <div class="btn-loader" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </button>
                            <button type="button" class="comment-preview-btn" id="previewBtn">
                                <i class="fas fa-eye"></i>
                                Preview
                            </button>
                        </div>
                        <div class="comment-guidelines">
                            <details>
                                <summary>
                                    <i class="fas fa-info-circle"></i>
                                    Comment Guidelines
                                </summary>
                                <ul>
                                    <li>Be respectful and constructive in your comments</li>
                                    <li>Stay on topic and relevant to the article</li>
                                    <li>No spam, self-promotion, or offensive content</li>
                                    <li>Comments are moderated and may take time to appear</li>
                                </ul>
                            </details>
                        </div>
                    </form>
                    
                    <!-- Comment Preview -->
                    <div class="comment-preview" id="commentPreview" style="display: none;">
                        <h4>Preview</h4>
                        <div class="preview-content"></div>
                        <button type="button" class="close-preview-btn" id="closePreviewBtn">
                            <i class="fas fa-times"></i>
                            Close Preview
                        </button>
                    </div>
                </div>
                
                <!-- Comments List -->
                <div class="comments-list">
                    {% for comment in comments %}
                        <div class="comment" id="comment-{{ comment.id }}">
                            <div class="comment-header">
                                <div class="comment-author">
                                    <div class="author-avatar">
                                        {{ comment.author_name|first|upper }}
                                    </div>
                                    <div class="author-info">
                                        <h4 class="author-name">
                                            {% if comment.author_website %}
                                                <a href="{{ comment.author_website }}" target="_blank" rel="nofollow">
                                                    {{ comment.author_name }}
                                                </a>
                                            {% else %}
                                                {{ comment.author_name }}
                                            {% endif %}
                                        </h4>
                                        <span class="comment-date">
                                            <i class="fas fa-clock"></i>
                                            {{ comment.created_at|date:"F d, Y \a\t g:i A" }}
                                        </span>
                                    </div>
                                </div>
                                <button class="reply-btn" onclick="toggleReplyForm({{ comment.id }})">
                                    <i class="fas fa-reply"></i>
                                    Reply
                                </button>
                            </div>
                            
                            <div class="comment-content">
                                {{ comment.content|linebreaks }}
                            </div>
                            
                            <!-- Reply Form (Hidden by default) -->
                            <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display: none;">
                                <h4>Reply to {{ comment.author_name }}</h4>
                                <form method="post" action="{% url 'blog:submit_reply' post.slug comment.id %}" class="reply-form">
                                    {% csrf_token %}
                                    <div class="form-row">
                                        <div class="form-group">
                                            <input type="text" name="author_name" placeholder="Your Name *" required maxlength="100" class="comment-input">
                                        </div>
                                        <div class="form-group">
                                            <input type="email" name="author_email" placeholder="Your Email *" required class="comment-input">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <input type="url" name="author_website" placeholder="Your Website (optional)" class="comment-input">
                                    </div>
                                    <div class="form-group">
                                        <textarea name="content" placeholder="Write your reply here... *" required rows="3" maxlength="2000" class="comment-textarea"></textarea>
                                    </div>
                                    <div class="reply-form-actions">
                                        <button type="submit" class="reply-submit-btn">
                                            <i class="fas fa-paper-plane"></i>
                                            Post Reply
                                        </button>
                                        <button type="button" class="cancel-reply-btn" onclick="toggleReplyForm({{ comment.id }})">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Replies -->
                            {% if comment.get_replies %}
                                <div class="replies">
                                    {% for reply in comment.get_replies %}
                                        <div class="reply" id="comment-{{ reply.id }}">
                                            <div class="comment-header">
                                                <div class="comment-author">
                                                    <div class="author-avatar">
                                                        {{ reply.author_name|first|upper }}
                                                    </div>
                                                    <div class="author-info">
                                                        <h5 class="author-name">
                                                            {% if reply.author_website %}
                                                                <a href="{{ reply.author_website }}" target="_blank" rel="nofollow">
                                                                    {{ reply.author_name }}
                                                                </a>
                                                            {% else %}
                                                                {{ reply.author_name }}
                                                            {% endif %}
                                                        </h5>
                                                        <span class="comment-date">
                                                            <i class="fas fa-clock"></i>
                                                            {{ reply.created_at|date:"F d, Y \a\t g:i A" }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="comment-content">
                                                {{ reply.content|linebreaks }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="no-comments">
                            <i class="fas fa-comment-slash"></i>
                            <p>No comments yet. Be the first to share your thoughts!</p>
                        </div>
                    {% endfor %}
                </div>
            </section>
        {% endif %}

        <!-- Enhanced Related Posts Section -->
        {% if related_posts %}
            <section class="related-posts-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-lightbulb"></i>
                        Related Articles
                    </h2>
                    <p class="section-subtitle">
                        Discover more content based on 
                        {% if post.categories.all %}
                            {% for category in post.categories.all %}
                                <a href="{% url 'blog:list_by_category' category.slug %}" class="category-link">{{ category.name }}</a>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% if post.tags.all and post.categories.all %} and {% endif %}
                        {% if post.tags.all %}
                            {% for tag in post.tags.all|slice:":3" %}
                                <a href="{% url 'blog:list_by_tag' tag.slug %}" class="tag-link" style="--tag-color: {{ tag.color }};">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        {% endif %}
                    </p>
                </div>
                
                <div class="related-posts-grid">
                    {% for related_post in related_posts %}
                        <article class="related-post-card">
                            {% if related_post.featured_image %}
                                <div class="related-post-image" style="background-image: url('{{ related_post.featured_image.url }}');"></div>
                            {% else %}
                                <div class="related-post-image related-post-placeholder">
                                    <i class="{% random_icon %}"></i>
                                </div>
                            {% endif %}
                            
                            <div class="related-post-content">
                                <div class="related-post-meta">
                                    {% if related_post.categories.first %}
                                        <span class="related-post-category">
                                            {{ related_post.categories.first.name }}
                                        </span>
                                    {% endif %}
                                    <span class="related-post-date">
                                        {{ related_post.created_at|date:"M d, Y" }}
                                    </span>
                                </div>
                                
                                <h3 class="related-post-title">
                                    <a href="{% url 'blog:detail' related_post.slug %}">
                                        {{ related_post.title }}
                                    </a>
                                </h3>
                                
                                <p class="related-post-excerpt">
                                    {{ related_post.excerpt|striptags|truncatechars:120 }}
                                </p>
                                
                                {% if related_post.tags.all %}
                                    <div class="related-post-tags">
                                        {% for tag in related_post.tags.all|slice:":2" %}
                                            <span class="related-post-tag" style="--tag-color: {{ tag.color }};">
                                                {{ tag.name }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                
                                <div class="related-post-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-eye"></i>
                                        {{ related_post.view_count }}
                                    </span>
                                    <span class="stat-item">
                                        <i class="fas fa-clock"></i>
                                        {{ related_post.read_time }} min
                                    </span>
                                </div>
                                
                                <a href="{% url 'blog:detail' related_post.slug %}" class="related-post-link">
                                    Read Article
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                            </div>
                        </article>
                    {% endfor %}
                </div>
                
                <!-- More Articles Link -->
                <div class="more-articles-section">
                    <a href="{% url 'blog:list' %}" class="more-articles-btn">
                        <i class="fas fa-th-large"></i>
                        Explore All Articles
                    </a>
                    {% if post.categories.first %}
                        <a href="{% url 'blog:list_by_category' post.categories.first.slug %}" class="more-articles-btn secondary">
                            <i class="fas fa-folder"></i>
                            More in {{ post.categories.first.name }}
                        </a>
                    {% endif %}
                </div>
            </section>
        {% else %}
            <!-- Fallback: Show popular posts if no related posts found -->
            <section class="related-posts-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-fire"></i>
                        Popular Articles
                    </h2>
                    <p class="section-subtitle">
                        Since we couldn't find related articles, here are some popular reads
                    </p>
                </div>
                
                <div class="popular-fallback-grid">
                    <!-- This would be populated by a separate context variable for popular posts -->
                    <div class="no-related-message">
                        <i class="fas fa-compass"></i>
                        <p>Discover more great content by exploring our <a href="{% url 'blog:list' %}">blog archive</a>.</p>
                    </div>
                </div>
            </section>
        {% endif %}
    </div>
    <script>
        // Blog Detail Page JavaScript Functionality

document.addEventListener('DOMContentLoaded', function() {
    // Reading Progress Bar
    const readingProgress = document.getElementById('readingProgress');
    
    function updateReadingProgress() {
        const article = document.querySelector('.article-content');
        if (!article) return;
        
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset;
        
        const articleBottom = articleTop + articleHeight;
        const windowBottom = scrollTop + windowHeight;
        
        if (scrollTop >= articleTop && scrollTop <= articleBottom - windowHeight) {
            const progress = ((scrollTop - articleTop) / (articleHeight - windowHeight)) * 100;
            readingProgress.style.width = Math.min(Math.max(progress, 0), 100) + '%';
        } else if (scrollTop < articleTop) {
            readingProgress.style.width = '0%';
        } else {
            readingProgress.style.width = '100%';
        }
    }
    
    window.addEventListener('scroll', updateReadingProgress);
    updateReadingProgress(); // Initial call

    // Share Button Functionality
    const shareBtn = document.getElementById('shareBtn');
    if (shareBtn) {
        shareBtn.addEventListener('click', function() {
            const url = window.location.href;
            const title = document.querySelector('.article-title')?.textContent || document.title;
            
            // Check if Web Share API is supported
            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: url
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: Copy to clipboard and show notification
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('Link copied to clipboard!', 'success');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('Link copied to clipboard!', 'success');
                });
            }
        });
    }

    // Bookmark/Save Button Functionality
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    if (bookmarkBtn) {
        const postSlug = window.location.pathname.split('/').filter(Boolean).pop();
        
        // Check if post is already bookmarked
        const savedPosts = JSON.parse(localStorage.getItem('savedPosts') || '[]');
        const isBookmarked = savedPosts.includes(postSlug);
        
        // Update button appearance based on bookmark status
        updateBookmarkButton(isBookmarked);
        
        bookmarkBtn.addEventListener('click', function() {
            const currentlySaved = savedPosts.includes(postSlug);
            
            if (currentlySaved) {
                // Remove from bookmarks
                const index = savedPosts.indexOf(postSlug);
                savedPosts.splice(index, 1);
                updateBookmarkButton(false);
                showNotification('Article removed from saved items', 'info');
            } else {
                // Add to bookmarks
                savedPosts.push(postSlug);
                updateBookmarkButton(true);
                showNotification('Article saved successfully!', 'success');
            }
            
            localStorage.setItem('savedPosts', JSON.stringify(savedPosts));
        });
    }

    // Helper function to update bookmark button appearance
    function updateBookmarkButton(isBookmarked) {
        const icon = bookmarkBtn.querySelector('i');
        const text = bookmarkBtn.querySelector('span');
        
        if (isBookmarked) {
            icon.className = 'fas fa-bookmark';
            text.textContent = 'Saved';
            bookmarkBtn.classList.add('bookmarked');
        } else {
            icon.className = 'far fa-bookmark';
            text.textContent = 'Save';
            bookmarkBtn.classList.remove('bookmarked');
        }
    }

    // Notification system
    function showNotification(message, type = 'info') {
        // Remove existing notification if any
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${getNotificationIcon(type)}"></i>
                <span>${message}</span>
            </div>
        `;

        // Add notification to page
        document.body.appendChild(notification);

        // Trigger animation
        setTimeout(() => notification.classList.add('show'), 100);

        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function getNotificationIcon(type) {
        switch (type) {
            case 'success': return 'check-circle';
            case 'error': return 'exclamation-circle';
            case 'warning': return 'exclamation-triangle';
            default: return 'info-circle';
        }
    }

    // Enhanced share options (optional)
    function showShareModal() {
        const url = window.location.href;
        const title = document.querySelector('.article-title')?.textContent || document.title;
        
        const shareModal = document.createElement('div');
        shareModal.className = 'share-modal-overlay';
        shareModal.innerHTML = `
            <div class="share-modal">
                <div class="share-modal-header">
                    <h3>Share Article</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="share-options">
                    <button class="share-option" data-platform="twitter">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                    <button class="share-option" data-platform="facebook">
                        <i class="fab fa-facebook"></i> Facebook
                    </button>
                    <button class="share-option" data-platform="linkedin">
                        <i class="fab fa-linkedin"></i> LinkedIn
                    </button>
                    <button class="share-option" data-platform="copy">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(shareModal);
        
        // Handle share option clicks
        shareModal.addEventListener('click', function(e) {
            if (e.target.classList.contains('share-modal-overlay') || 
                e.target.classList.contains('close-modal')) {
                shareModal.remove();
                return;
            }
            
            const platform = e.target.closest('.share-option')?.dataset.platform;
            if (platform) {
                handleSharePlatform(platform, url, title);
                shareModal.remove();
            }
        });
    }

    function handleSharePlatform(platform, url, title) {
        const encodedUrl = encodeURIComponent(url);
        const encodedTitle = encodeURIComponent(title);
        
        switch (platform) {
            case 'twitter':
                window.open(`https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`, '_blank');
                break;
            case 'facebook':
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`, '_blank');
                break;
            case 'linkedin':
                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`, '_blank');
                break;
            case 'copy':
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('Link copied to clipboard!', 'success');
                });
                break;
        }
    }
});

// Copy Button Functionality for Code Blocks
function initializeCopyButtons() {
    // Find all pre elements (code blocks)
    const codeBlocks = document.querySelectorAll('pre');
    
    codeBlocks.forEach((pre, index) => {
        // Create copy button
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
        copyBtn.setAttribute('data-index', index);
        
        // Style the button
        copyBtn.style.cssText = `
            position: absolute;
            top: 0.8rem;
            right: 1rem;
            background: rgba(0, 255, 255, 0.1);
            color: #00ffff;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'Orbitron', sans-serif;
            border: 1px solid rgba(0, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            backdrop-filter: blur(10px);
        `;
        
        // Add hover effect
        copyBtn.addEventListener('mouseenter', () => {
            copyBtn.style.background = 'rgba(0, 255, 255, 0.2)';
            copyBtn.style.transform = 'scale(1.05)';
        });
        
        copyBtn.addEventListener('mouseleave', () => {
            copyBtn.style.background = 'rgba(0, 255, 255, 0.1)';
            copyBtn.style.transform = 'scale(1)';
        });
        
        // Add click event
        copyBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            
            // Get the code text
            const codeText = pre.textContent || pre.innerText;
            
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(codeText);
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = codeText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    textArea.remove();
                }
                
                // Show success feedback
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                copyBtn.style.background = 'rgba(0, 255, 0, 0.2)';
                copyBtn.style.color = '#00ff00';
                
                // Show notification if your notification system exists
                if (typeof showNotification === 'function') {
                    showNotification('Code copied to clipboard!', 'success');
                }
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    copyBtn.style.background = 'rgba(0, 255, 255, 0.1)';
                    copyBtn.style.color = '#00ffff';
                }, 2000);
                
            } catch (err) {
                console.error('Copy failed:', err);
                copyBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
                copyBtn.style.background = 'rgba(255, 0, 0, 0.2)';
                copyBtn.style.color = '#ff0000';
                
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    copyBtn.style.background = 'rgba(0, 255, 255, 0.1)';
                    copyBtn.style.color = '#00ffff';
                }, 2000);
            }
        });
        
        // Make sure the pre element has relative positioning
        pre.style.position = 'relative';
        
        // Append button to the pre element
        pre.appendChild(copyBtn);
    });
}

// Initialize copy buttons when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Your existing DOMContentLoaded code here...
    
    // Initialize copy buttons
    initializeCopyButtons();
    
    // Re-initialize if content is dynamically loaded
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // Check if any new pre elements were added
                const hasNewCodeBlocks = Array.from(mutation.addedNodes).some(node => 
                    node.nodeType === 1 && (node.tagName === 'PRE' || node.querySelector('pre'))
                );
                
                if (hasNewCodeBlocks) {
                    // Small delay to ensure content is fully rendered
                    setTimeout(initializeCopyButtons, 100);
                }
            }
        });
    });
    
    // Start observing the article content for changes
    const articleContent = document.querySelector('.article-content');
    if (articleContent) {
        observer.observe(articleContent, {
            childList: true,
            subtree: true
        });
    }
});

// Comment System JavaScript Functions
function toggleReplyForm(commentId) {
    const replyForm = document.getElementById('reply-form-' + commentId);
    if (replyForm) {
        if (replyForm.style.display === 'none' || replyForm.style.display === '') {
            replyForm.style.display = 'block';
            // Focus on the first input field
            const firstInput = replyForm.querySelector('input[name="author_name"]');
            if (firstInput) {
                firstInput.focus();
            }
        } else {
            replyForm.style.display = 'none';
        }
    }
}

// Re-initialize if content is dynamically loaded
const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
            // Check if any new pre elements were added
            const hasNewCodeBlocks = Array.from(mutation.addedNodes).some(node => 
                node.nodeType === 1 && (node.tagName === 'PRE' || node.querySelector('pre'))
            );
            
            if (hasNewCodeBlocks) {
                // Small delay to ensure content is fully rendered
                setTimeout(initializeCopyButtons, 100);
            }
        }
    });
});

// Start observing the article content for changes
const articleContent = document.querySelector('.article-content');
if (articleContent) {
    observer.observe(articleContent, {
        childList: true,
        subtree: true
    });
}
});
    </script>
    
    <!-- Table of Contents JavaScript -->
    {% if toc_data.show_toc %}
        <script src="{% static 'js/table-of-contents.js' %}"></script>
    {% endif %}
{% endblock %}
